#testing RPANDA approach for multivariate trait modeling

require(geiger)
require(phytools)
require(deSolve)

set.seed(1234)
tree<-rcoal(3)

vcv(tree)

#          t3        t2       t1
#t3 1.0806784 0.2467589 0.000000
#t2 0.2467589 1.0806784 0.000000
#t1 0.0000000 0.0000000 1.080678

source('~/Dropbox/Post-graduate students/MBiol Students/Draisey_Sam/multivariate models/PhenotypicModel_MV_BETA.R', chdir = TRUE)
source('~/Dropbox/Post-graduate students/MBiol Students/Draisey_Sam/multivariate models/createModel_BM_MV.R', chdir = TRUE)

getTipDistribution(bbm,params=c(0,0,0,0,0))

#> getTipDistribution(bbm,params=c(0,0,0,0,0))
#$mean
#   [,1]
#t3    0
#t1    0
#t2    0
#t3    0
#t1    0
#t2    0
#
#$Sigma
#          t3       t1        t2        t3       t1        t2
#t3 1.0806784 0.000000 0.2467589 0.0000000 0.000000 0.0000000
#t1 0.0000000 1.080678 0.0000000 0.0000000 0.000000 0.0000000
#t2 0.2467589 0.000000 1.0806784 0.0000000 0.000000 0.0000000
#t3 0.0000000 0.000000 0.0000000 1.0806784 0.000000 0.2467589
#t1 0.0000000 0.000000 0.0000000 0.0000000 1.080678 0.0000000
#t2 0.0000000 0.000000 0.0000000 0.2467589 0.000000 1.0806784


##looks to be working fine with sigma=1




vcv(tree)*0.5

#          t3        t2        t1
#t3 0.5403392 0.1233794 0.0000000
#t2 0.1233794 0.5403392 0.0000000
#t1 0.0000000 0.0000000 0.5403392


#> getTipDistribution(bbm,params=c(0,0,log(sqrt(0.5)),log(sqrt(0.5)),0))
#$mean
#   [,1]
#t3    0
#t1    0
#t2    0
#t3    0
#t1    0
#t2    0
#
#$Sigma
#          t3        t1        t2        t3        t1        t2
#t3 0.5403392 0.0000000 0.1233794 0.0000000 0.0000000 0.0000000
#t1 0.0000000 0.5403392 0.0000000 0.0000000 0.0000000 0.0000000
#t2 0.1233794 0.0000000 0.5403392 0.0000000 0.0000000 0.0000000
#t3 0.0000000 0.0000000 0.0000000 0.5403392 0.0000000 0.1233794
#t1 0.0000000 0.0000000 0.0000000 0.0000000 0.5403392 0.0000000
#t2 0.0000000 0.0000000 0.0000000 0.1233794 0.0000000 0.5403392


#> kronecker(diag(2)*0.5,vcv(tree))
#          [,1]      [,2]      [,3]      [,4]      [,5]      [,6]
#[1,] 0.5403392 0.1233794 0.0000000 0.0000000 0.0000000 0.0000000
#[2,] 0.1233794 0.5403392 0.0000000 0.0000000 0.0000000 0.0000000
#[3,] 0.0000000 0.0000000 0.5403392 0.0000000 0.0000000 0.0000000
#[4,] 0.0000000 0.0000000 0.0000000 0.5403392 0.1233794 0.0000000
#[5,] 0.0000000 0.0000000 0.0000000 0.1233794 0.5403392 0.0000000
#[6,] 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.5403392

##looks to be working fine with sigma=sqrt(0.5)




### some sort of error when the covariance term is introduced:

#> getTipDistribution(bbm,params=c(0,0,log(sqrt(2)),log(sqrt(2)),0.2))
#$mean
#   [,1]
#t3    0
#t1    0
#t2    0
#t3    0
#t1    0
#t2    0
#
#$Sigma
#          t3       t1        t2        t3       t1        t2
#t3 2.2045840 0.000000 0.5033881 0.6113240 0.000000 0.1395879
#t1 0.0000000 2.204584 0.0000000 0.0000000 0.611324 0.0000000
#t2 0.5033881 0.000000 2.2045840 0.1395879 0.000000 0.6113240
#t3 0.6113240 0.000000 0.1395879 2.2045840 0.000000 0.5033881
#t1 0.0000000 0.611324 0.0000000 0.0000000 2.204584 0.0000000
#t2 0.1395879 0.000000 0.6113240 0.5033881 0.000000 2.2045840
#
#> kronecker(diag(2)*2,vcv(tree))
#> diag(2)*2
#     [,1] [,2]
#[1,]    2    0
#[2,]    0    2
#> diag(2)*2->sig2.mat
#> sig2.mat[1,2]=0.2
#> sig2.mat[2,1]=0.2
#> sig2.mat
#     [,1] [,2]
#[1,]  2.0  0.2
#[2,]  0.2  2.0
#> diag(2)*2
#> kronecker(sig2.mat,vcv(tree))
#           [,1]       [,2]      [,3]       [,4]       [,5]      [,6]
#[1,] 2.16135684 0.49351777 0.0000000 0.21613568 0.04935178 0.0000000
#[2,] 0.49351777 2.16135684 0.0000000 0.04935178 0.21613568 0.0000000
#[3,] 0.00000000 0.00000000 2.1613568 0.00000000 0.00000000 0.2161357
#[4,] 0.21613568 0.04935178 0.0000000 2.16135684 0.49351777 0.0000000
#[5,] 0.04935178 0.21613568 0.0000000 0.49351777 2.16135684 0.0000000
#[6,] 0.00000000 0.00000000 0.2161357 0.00000000 0.00000000 2.1613568
#> 


##must be that matrixGamma isn't constructed correctly (e.g., there shouldn't be offdiagonal terms perhaps?)